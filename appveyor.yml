# [CORE-17585] VS 2017/2019/2022 14.0: Same 8+1 + 1 path error(s) (as GitHub), on asm-16 commands.
image:
  - Visual Studio 2022
  - Visual Studio 2019
    # 'CMake 3.17.0 or higher is required. You are running version 3.16.2' :-(
  - Visual Studio 2017
    # 'CMake 3.17.0 or higher is required. You are running version 3.16.2' :-(
  - Visual Studio 2015

environment:
  matrix:
    - BuildType: "msvc-x64"

version: VS2015-amd64.reactos.appveyor.{build}
skip_branch_with_pr: true
clone_depth: 5
clone_folder: c:\reactos-cov
matrix:
  fast_finish: false

init:
  - set
# 2017/2019/2022.
# FAILED: boot/freeldr/freeldr/frldr16.bin.obj
# cmd.exe /C "cd /D C:\ros_build\boot\freeldr\freeldr && "C:\Program Files (x86)\Microsoft Visual Studio 14.0\VC\\bin\HostX86\x86\ml.exe" /nologo /Cp /FoC:/ros_build/boot/freeldr/freeldr/frldr16.bin.obj /c /Ta C:/ros_build/boot/freeldr/freeldr/frldr16.bin.tmp"
# The system cannot find the path specified.
#   - dir "C:\"
#   - dir "C:\Program Files (x86)\"
#   - dir "C:\Program Files (x86)\Microsoft Visual Studio 14.0\"
#   - dir "C:\Program Files (x86)\Microsoft Visual Studio 14.0\VC\"
#   - dir "C:\Program Files (x86)\Microsoft Visual Studio 14.0\VC\bin\"
# 2015/2017/2019/2022.
# dir "C:\Program Files (x86)\Microsoft Visual Studio 14.0\VC\bin\HostX86\"
# The system cannot find the file specified.
# --> Should be "...\<arch>\": amd64, amd64_arm, amd64_x86, arm, "" (x86), x86_amd64, x86_arm.
#   - dir "C:\Program Files (x86)\Microsoft Visual Studio 14.0\VC\bin\HostX86\"
#   - dir "C:\Program Files (x86)\Microsoft Visual Studio 14.0\VC\bin\HostX86\x86\"
#   - dir "C:\Program Files (x86)\Microsoft Visual Studio 14.0\VC\bin\HostX86\x86\ml.exe"
#   - dir "C:\Program Files (x86)\Microsoft Visual Studio 14.0\VC\\bin\HostX86\x86\ml.exe"
  - dir "C:\Program Files (x86)\Microsoft Visual Studio 14.0\VC\bin\"
  - dir "C:\Program Files (x86)\Microsoft Visual Studio 14.0\VC\bin\amd64_x86\"
#   - exit
  - ps: (New-Object System.Net.WebClient).DownloadFile("https://svn.reactos.org/storage/vperevertkin/flexbison.7z","C:\flexbison.7z")
    # AppV: %APPVEYOR_BUILD_FOLDER% must remain empty at this stage :-/
  - 7z x C:\flexbison.7z -oC:\RosCMakeNinja\bin
  - set PATH=;%PATH%;C:\RosCMakeNinja\bin
  - set BISON_PKGDATADIR=C:\RosCMakeNinja\bin\share\bison
  - set M4=C:\RosCMakeNinja\bin\m4.exe

build_script:
#   - set PATH=C:\RosCMakeNinja\bin;%PATH%
    # On VS2015/VS2017 images: OK.
  - if "%APPVEYOR_BUILD_WORKER_IMAGE%" == "Visual Studio 2015"  if "%BuildType%" == "msvc-x64" (
        call "C:\Program Files (x86)\Microsoft Visual Studio 14.0\VC\vcvarsall.bat" amd64
      ) else (
        call "C:\Program Files (x86)\Microsoft Visual Studio 14.0\VC\vcvarsall.bat" amd64_x86
      )
    # On VS2017 image: Fails.
  - if "%APPVEYOR_BUILD_WORKER_IMAGE%" == "Visual Studio 2017"  if "%BuildType%" == "msvc-x64" (
        call "C:\Program Files (x86)\Microsoft Visual Studio\2017\Community\VC\Auxiliary\Build\vcvarsall.bat" amd64 -vcvars_ver=14.0
      ) else (
        call "C:\Program Files (x86)\Microsoft Visual Studio\2017\Community\VC\Auxiliary\Build\vcvarsall.bat" amd64_x86 -vcvars_ver=14.0
      )
    # On VS2019 image: Fails.
  - if "%APPVEYOR_BUILD_WORKER_IMAGE%" == "Visual Studio 2019"  if "%BuildType%" == "msvc-x64" (
        call "C:\Program Files (x86)\Microsoft Visual Studio\2019\Community\VC\Auxiliary\Build\vcvarsall.bat" amd64 -vcvars_ver=14.0
      ) else (
        call "C:\Program Files (x86)\Microsoft Visual Studio\2019\Community\VC\Auxiliary\Build\vcvarsall.bat" amd64_x86 -vcvars_ver=14.0
      )
  - if "%APPVEYOR_BUILD_WORKER_IMAGE%" == "Visual Studio 2022"  if "%BuildType%" == "msvc-x64" (
        call "C:\Program Files\Microsoft Visual Studio\2022\Community\VC\Auxiliary\Build\vcvarsall.bat" amd64 -vcvars_ver=14.0
      ) else (
        call "C:\Program Files\Microsoft Visual Studio\2022\Community\VC\Auxiliary\Build\vcvarsall.bat" amd64_x86 -vcvars_ver=14.0
      )
  - cmake --version
  - md c:\ros_build
  - cd c:\ros_build
  - call %APPVEYOR_BUILD_FOLDER%\configure.cmd
  - ps: >-
      & ninja 2>&1

test: off
deploy: off
