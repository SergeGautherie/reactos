image: Ubuntu

environment:
# SSH:   APPVEYOR_SSH_KEY: ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDgGIoNKEMMl4zlT1qUCZtW4Zk5CgHMFzn0ZszB6vyWn19Dc64yrhCU8AgtdOa2wEoBMRyKHPktkVEn7r7yRBpAF9UjyfWEaMWSLzfPJxOdtmjFDJKx8AYV2bk6o6KWX+jH1qtz+7zqELYdV8UzHgEe1MUpqCI4kJDTSpU6q92MJCiazda0VeFlyYwet9lXrT7pzM0I2tBHQzdD1pvY/vTwAfKw/+ZF0StswIPZfsmM2JeajH94BIYhX1DjhGHWLmqpW6QPTjBGFu1mtFF4P50fhz5JIx57K1Sd7GDtNR+Q3+ICG5nF99I7g+XFoWGjCGZ+LWYdAEu9lEezft8+cQ91
# PuTTY: 
  APPVEYOR_SSH_KEY: ssh-rsa AAAAB3NzaC1yc2EAAAABJQAAAQEAtPJhVrHblWPjguvbjz4bhzO0QgvogHs8nxXFhXKpr6htEinjuaLSn2acctY/aIv9SMDiAwORisZtZ7HltUvBL0Bl3Zn+bOtqbqkcgTXj2uQJpebCT+FNaHMogbcpu+hZvztoj/59F1e9VnJDz9X32SVJwaO7F/TP7Z32Vcx9Ui+GQ3RnmmnlQI/V8NoQw0sOibnJou3MdZW6fBLIGdZ6WkWsz4SNvymXK6CA+uelVpUWa4z2GHfFSdQP4oIItYwln2FHELwTPiJLP76AyCO3VMDoHMEAjhGkGusnRHQg5oj8tLbmyO+kjW0XVC0W8AXJnkWxWbnHN83O1f+gMqM8zw==
#     secure: ...
#   APPVEYOR_SSH_BLOCK: true
#
  ROS_WGET_BOOTCDREGTEST: https://iso.reactos.org/bootcdregtest/reactos-bootcdregtest-0.4.11-dev-34-g191dceb-x86-gcc-lin-dbg.iso
  BuildVersion: $APPVEYOR_BUILD_NUMBER-${APPVEYOR_REPO_COMMIT:0:7}-gcc

version: Host-Tools.reactos.appveyor.{build}
skip_branch_with_pr: true
clone_depth: 5
clone_folder: ~/ros_workdir/reactos-cov

init:
#   - sh: export APPVEYOR_SSH_BLOCK=true
# 
  - sh: curl -sflL 'https://raw.githubusercontent.com/appveyor/ci/master/scripts/enable-ssh.sh' | bash -e -

install:
  - sh: cd ~/ros_workdir
  - sh: wget --no-verbose https://svn.reactos.org/amine/RosBEBinFull.tar.gz
  - sh: chmod u-w RosBEBinFull.tar.gz
  - sh: ll RosBEBinFull.tar.gz
  - sh: tar -xzf RosBEBinFull.tar.gz
#
  - sh: mkdir Build
  - sh: mkdir ~/ros_workdir/TestRun

build_script:
  - sh: cd Build
  - sh: echo 'cd ../Build && $APPVEYOR_BUILD_FOLDER/configure.sh && cd reactos && ninja -k0 host-tools' > RosBE_build_script_file.txt
  - sh: ../RosBEBinFull/RosBE.sh < RosBE_build_script_file.txt

after_build:
  - sh: cd reactos/host-tools
  - sh: appveyor PushArtifact log2lines -FileName log2lines-$BuildVersion
  - sh: appveyor PushArtifact raddr2line -FileName raddr2line-$BuildVersion
#
  - sh: chmod go-x log2lines
  - sh: ll log2lines

test_script:
  - sh: cd ~/ros_workdir/TestRun
#
  - sh: wget --no-verbose --output-document=bootcdregtest.iso "$ROS_WGET_BOOTCDREGTEST"
  - sh: chmod u-w bootcdregtest.iso
  - sh: ll bootcdregtest.iso
#
  - sh: ln ~/ros_workdir/Build/reactos/host-tools/log2lines
  - sh: ./log2lines -d bootcdregtest.iso -F

deploy: off

on_finish:
  - sh: export APPVEYOR_SSH_BLOCK=true
  - sh: curl -sflL 'https://raw.githubusercontent.com/appveyor/ci/master/scripts/enable-ssh.sh' | bash -e -
