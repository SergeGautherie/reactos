image:
# Regressed :-( + Workaround!
#   - Previous Visual Studio 2019
    # VS (9/2008, 10/2010, 11/2012, 12/2013).
#   - Visual Studio 2013
    # 'Microsoft Windows [Version 6.3.9600]'
# VS2008: last to target 2000.
    # VS (9/2008, 10/2010, 11/2012, 12/2013,) 14/2015.
# 
  - Visual Studio 2015
    # 'Microsoft Windows [Version 10.0.14393]'
# VS2017 (v141): last to target XP/S2003.
    # VS 14/2015, 15/2017.
#   - Visual Studio 2017
    # VS 16/2019.
#   - Visual Studio 2019
    # Very slow (= minutes) to start.
# Regressed :-( + Workaround!
#   - Visual Studio 2019 Preview

environment:
  matrix:
# 
  - BuildType: "msvc-x64"
    USE_ROSBE_VERSION: 21
  - BuildType: "msvc-x64"
    USE_ROSBE_VERSION: 22
  - BuildType: "msvc"
    USE_ROSBE_VERSION: 21
  - BuildType: "msvc"
    USE_ROSBE_VERSION: 22
#    - BuildType: "clang-cl"
#    - BuildType: vssolution
#    - BuildType: vssolution-x64

version: VS2015.reactos.appveyor.{build}
skip_branch_with_pr: true
clone_depth: 5
clone_folder: C:\projects\reactos-git

init:
#   - dir "C:\Program Files (x86)"
#   - dir "C:\Program Files (x86)\Microsoft Visual Studio\2019\Community\vcvarsall.bat" /s
#   - dir "C:\Program Files (x86)\Microsoft Visual Studio\2019\Community\VC" /s
#   - dir "C:\Program Files (x86)\Microsoft Visual Studio 14.0"
# D_RosBE-21
#   - ps: (New-Object System.Net.WebClient).DownloadFile("https://svn.reactos.org/amine/RosCMakeNinja.zip","C:\RosCMakeNinja.zip")
#   - 7z x C:\RosCMakeNinja.zip -oC:\RosCMakeNinja
#   - del C:\RosCMakeNinja\bin\ninja.exe
# F_RosBE-21
# D_RosBE-22
#   - ps: (New-Object System.Net.WebClient).DownloadFile("https://svn.reactos.org/storage/vperevertkin/flexbison.7z","C:\projects\flexbison.7z")
#   - 7z x C:\projects\flexbison.7z -oC:\projects\bin
# F_RosBE-22
#   - ps: >-
#       If ($env:BuildType -Match "clang-cl") {
#         $env:clang_configure_option="clang"
#         (New-Object System.Net.WebClient).DownloadFile("https://svn.reactos.org/amine/clang-cl.7z","C:\clang-cl.7z")
#         7z x C:\clang-cl.7z -oC:\RosCMakeNinja\bin
#       } Else {
#         $env:clang_configure_option=""
#       }
      # cmake.exe, cmcldeps.exe, ninja.exe.
#   - dir /s C:\RosCMakeNinja\bin

build_script:
  - ver
# D_RosBE-21
    # RosBE 2.1.x (+PCH), x86(_64): VS2015 9-11 min, VS2017 +1(,5) min.
    #   'cmake version 3.2.1-ReactOS'
    #   Ninja: (RosBE) '1.5.3' or (AppVeyor) '1.9.0'
#   - set PATH=C:\RosCMakeNinja\bin;%PATH%
# F_RosBE-21
# D_RosBE-22
    # (No =) RosBE 2.2.0 (-PCH), x86(_64): VS2015 23 + 17 min, VS2017 22 + 23 min.
    #   'cmake version 3.16.2'
    #   Ninja: (AppVeyor) '1.9.0'
#   - set PATH=C:\projects\bin;%PATH%
# F_RosBE-22
  - if "%BuildType%" == "msvc-x64" (
        call "C:\Program Files (x86)\Microsoft Visual Studio 14.0\VC\vcvarsall.bat" amd64
      ) else (
        call "C:\Program Files (x86)\Microsoft Visual Studio 14.0\VC\vcvarsall.bat" x86
      )
#   - if exist "C:\Program Files (x86)\Microsoft Visual Studio\2019\Preview\VC\Auxiliary\Build\vcvarsall.bat" (
#         if "%BuildType%" == "msvc-x64" (
#             call "C:\Program Files (x86)\Microsoft Visual Studio\2019\Preview\VC\Auxiliary\Build\vcvarsall.bat" amd64
#         ) else (
#             call "C:\Program Files (x86)\Microsoft Visual Studio\2019\Preview\VC\Auxiliary\Build\vcvarsall.bat" x86
#         )
#     ) else (
#         if "%BuildType%" == "msvc-x64" (
#             call "C:\Program Files (x86)\Microsoft Visual Studio\2019\Community\VC\Auxiliary\Build\vcvarsall.bat" amd64
#         ) else (
#             call "C:\Program Files (x86)\Microsoft Visual Studio\2019\Community\VC\Auxiliary\Build\vcvarsall.bat" x86
#         )
#     )
#   - where find
#   - which find
#     # https://github.com/appveyor/ci/issues/3147 workaround!
#   - del "C:\Program Files\Git\usr\bin\find.exe"
#   - where find
#   - which find
#   - cl 2>&1
  - cmake --version
  - ninja --version
  - md c:\ros_build
  - cd c:\ros_build
# D_RosBE-21
#   - call %APPVEYOR_BUILD_FOLDER%\configure.cmd
# F_RosBE-21
# D_RosBE-22
  - if "%BuildType%" == "msvc-x64" (
        cmake -G Ninja -DCMAKE_TOOLCHAIN_FILE:FILEPATH=toolchain-msvc.cmake -DARCH:STRING=amd64 %APPVEYOR_BUILD_FOLDER%
      ) else (
        cmake -G Ninja -DCMAKE_TOOLCHAIN_FILE:FILEPATH=toolchain-msvc.cmake -DARCH:STRING=i386 %APPVEYOR_BUILD_FOLDER%
      )
# F_RosBE-22
# D_RosBE-21
#   - ps: >-
#       & ninja -k0 2>&1 | select-string -pattern "\[\d+\/\d+\] " -NotMatch | %{$_.Line}
# F_RosBE-21
# D_RosBE-22
  - ps: >-
      & cmake --build . -- -k 0 2>&1 | select-string -pattern "\[\d+\/\d+\] " -NotMatch | %{$_.Line}
# F_RosBE-22

test: off

deploy: off

for:
-
  matrix:
    only:
      - USE_ROSBE_VERSION: 21

  init:
    - ps: (New-Object System.Net.WebClient).DownloadFile("https://svn.reactos.org/amine/RosCMakeNinja.zip","C:\RosCMakeNinja.zip")
    - 7z x C:\RosCMakeNinja.zip -oC:\RosCMakeNinja
      # Use newer, already installed.
    - del C:\RosCMakeNinja\bin\ninja.exe
      # RosBE 2.1.x (+PCH), x86(_64): VS2015 9-11 min, VS2017 +1(,5) min.
      #   'cmake version 3.2.1-ReactOS'
      #   Ninja: (RosBE) '1.5.3' or (AppVeyor) '1.9.0'
    - set PATH=C:\RosCMakeNinja\bin;%PATH%

-
  matrix:
    only:
      - USE_ROSBE_VERSION: 22

  init:
      # Not used yet.
#     - ps: (New-Object System.Net.WebClient).DownloadFile("https://svn.reactos.org/storage/vperevertkin/flexbison.7z","C:\projects\flexbison.7z")
#     - 7z x C:\projects\flexbison.7z -oC:\projects\bin
      # (No =) RosBE 2.2.0 (-PCH), x86(_64): VS2015 23 + 17 min, VS2017 22 + 23 min.
      #   'cmake version 3.16.2'
      #   Ninja: (AppVeyor) '1.9.0'
#     - set PATH=C:\projects\bin;%PATH%
