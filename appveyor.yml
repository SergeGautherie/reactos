environment:
  matrix:
#     - BuildType: "msvc-x64"
# 
    - BuildType: "msvc"
#     - BuildType: "clang-cl"
#     - APPVEYOR_BUILD_WORKER_IMAGE: Visual Studio 2013
#       BuildType: "clang-cl"
#     - APPVEYOR_BUILD_WORKER_IMAGE: Visual Studio 2015
#       BuildType: "clang-cl"
#     - APPVEYOR_BUILD_WORKER_IMAGE: Visual Studio 2017
#       BuildType: "clang-cl"
#     - APPVEYOR_BUILD_WORKER_IMAGE: Visual Studio 2013
#       BuildType: "msvc"
#     - APPVEYOR_BUILD_WORKER_IMAGE: Visual Studio 2015
#       BuildType: "msvc"
#     - APPVEYOR_BUILD_WORKER_IMAGE: Visual Studio 2017
#       BuildType: "msvc"
# Tout refaire/fusionner
#     - APPVEYOR_BUILD_WORKER_IMAGE: Ubuntu
#
#   APPVEYOR_RDP_PASSWORD:
#     secure: amQ18PhcGpzi95VrjdE94A==

version: reactos.appveyor.{build}
skip_branch_with_pr: true
clone_depth: 5
clone_folder: c:\reactos-cov

init:
#   - ps: iex ((new-object net.webclient).DownloadString('https://raw.githubusercontent.com/appveyor/ci/master/scripts/enable-rdp.ps1'))
#
  - ps: (New-Object System.Net.WebClient).DownloadFile("https://svn.reactos.org/amine/RosCMakeNinja.zip","C:\RosCMakeNinja.zip")
  - 7z x C:\RosCMakeNinja.zip -oC:\RosCMakeNinja
  - ps: >-
      If ($env:BuildType -Match "clang-cl") {
        $env:clang_configure_option="clang"
        (New-Object System.Net.WebClient).DownloadFile("https://svn.reactos.org/amine/clang-cl.7z","C:\clang-cl.7z")
        7z x C:\clang-cl.7z -oC:\RosCMakeNinja\bin
      } Else {
        $env:clang_configure_option=""
      }

build_script:
#   - cmd: dir "C:\Program Files (x86)"
#   - cmd: dir C:\RosCMakeNinja
#
  - set PATH=C:\RosCMakeNinja\bin;%PATH%
  - if "%BuildType%" == "msvc-x64" (
        call "C:\PROGRA~2\Microsoft Visual Studio 14.0\VC\vcvarsall.bat" amd64
      ) else (
        call "C:\Program Files (x86)\Microsoft Visual Studio 10.0\VC\vcvarsall.bat" x86
      )
  - cmake --version
  - md c:\ros_build
  - cd c:\ros_build
  - call %APPVEYOR_BUILD_FOLDER%\configure.cmd %clang_configure_option% -DENABLE_ROSTESTS=1
  - ps: >-
      & ninja -k0 rostests 2>&1 | select-string -pattern "\[\d+\/\d+\] " -NotMatch | %{$_.Line}
#   - ps: >-
#       & ninja bootcdregtest 2>&1 | select-string -pattern "\[\d+\/\d+\] " -NotMatch | %{$_.Line}

after_build:
  - cmd: set SGVER=%APPVEYOR_BUILD_NUMBER%-%APPVEYOR_REPO_COMMIT:~0,7%-%BuildType%
#
  - cmd: appveyor PushArtifact ..\ros_build\modules\rostests\apitests\apphelp\apphelp_apitest.exe -FileName apphelp_apitest-%SGVER%.exe
#
#   - appveyor PushArtifact ..\ros_build\bootcdregtest.iso
# 500_avant
#   - cmd: appveyor PushArtifact ..\ros_build\bootcdregtest.iso -FileName bootcdregtest-%SGVER%.iso
#   - cmd: ren ..\ros_build\bootcdregtest.iso bootcdregtest-E-%SGVER%.iso
# 500_avant
#   - cmd: appveyor PushArtifact ..\ros_build\bootcdregtest-E-%SGVER%.iso

test: off

test_script:
# Sans/Avec '"', affiche l'aide de CALL :-/
# De toute facon, plus aucun parametre n'est supporte.
#   - cmd: "ver /?"
# S2012 == 8.1
#   - cmd: ver
#
  - cmd: cd modules\rostests\apitests\apphelp
  - cmd: cmd /V:ON /C "apphelp_apitest db  & echo ErrorLevel=!errorlevel!"
  - cmd: cmd /V:ON /C "apphelp_apitest env  & echo ErrorLevel=!errorlevel!"

deploy: off

# on_finish:
#   - ps: $blockRdp = $true; iex ((new-object net.webclient).DownloadString('https://raw.githubusercontent.com/appveyor/ci/master/scripts/enable-rdp.ps1'))
