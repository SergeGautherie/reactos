image:
# Regressed :-( + Workaround!
#   - Previous Visual Studio 2019
  - Visual Studio 2019
    # Very slow (= minutes) to start.
# Regressed :-( + Workaround!
#   - Visual Studio 2019 Preview

environment:
  matrix:
 # CORE-16426, Stub/Im-plement new __CxxFrameHandler4(), to compile ROS x64 with VS2019
#    - BuildType: "msvc-x64"
#
    - BuildType: "msvc"
#    - BuildType: "clang-cl"
#    - BuildType: vssolution
#    - BuildType: vssolution-x64

version: BCD-RT.VS2019.reactos.appveyor.{build}
skip_branch_with_pr: true
clone_depth: 5
clone_folder: c:\reactos-cov

init:
#   - dir "C:\Program Files (x86)"
#   - dir "C:\Program Files (x86)\Microsoft Visual Studio\2019\Community\vcvarsall.bat" /s
#   - dir "C:\Program Files (x86)\Microsoft Visual Studio\2019\Community\VC" /s
#   - dir "C:\Program Files (x86)\Microsoft Visual Studio 14.0"
  - ps: (New-Object System.Net.WebClient).DownloadFile("https://svn.reactos.org/amine/RosCMakeNinja.zip","C:\RosCMakeNinja.zip")
  - 7z x C:\RosCMakeNinja.zip -oC:\RosCMakeNinja
  - ps: >-
      If ($env:BuildType -Match "clang-cl") {
        $env:clang_configure_option="clang"
        (New-Object System.Net.WebClient).DownloadFile("https://svn.reactos.org/amine/clang-cl.7z","C:\clang-cl.7z")
        7z x C:\clang-cl.7z -oC:\RosCMakeNinja\bin
      } Else {
        $env:clang_configure_option=""
      }
      # cmake.exe, cmcldeps.exe, ninja.exe.
#   - dir /s C:\RosCMakeNinja\bin

build_script:
    # With/Old: 16/18 min, Without/Current: 22/26 min :-<
#   - set PATH=C:\RosCMakeNinja\bin;%PATH%
#   - if "%BuildType%" == "msvc-x64" (
#         call "C:\Program Files (x86)\Microsoft Visual Studio 14.0\VC\vcvarsall.bat" amd64
#       ) else (
#         call "C:\Program Files (x86)\Microsoft Visual Studio 14.0\VC\vcvarsall.bat" x86
#       )
  - if exist "C:\Program Files (x86)\Microsoft Visual Studio\2019\Preview\VC\Auxiliary\Build\vcvarsall.bat" (
        if "%BuildType%" == "msvc-x64" (
            call "C:\Program Files (x86)\Microsoft Visual Studio\2019\Preview\VC\Auxiliary\Build\vcvarsall.bat" amd64
        ) else (
            call "C:\Program Files (x86)\Microsoft Visual Studio\2019\Preview\VC\Auxiliary\Build\vcvarsall.bat" x86
        )
    ) else (
        if "%BuildType%" == "msvc-x64" (
            call "C:\Program Files (x86)\Microsoft Visual Studio\2019\Community\VC\Auxiliary\Build\vcvarsall.bat" amd64
        ) else (
            call "C:\Program Files (x86)\Microsoft Visual Studio\2019\Community\VC\Auxiliary\Build\vcvarsall.bat" x86
        )
    )
#   - where find
#   - which find
#     # https://github.com/appveyor/ci/issues/3147 workaround!
#   - del "C:\Program Files\Git\usr\bin\find.exe"
#   - where find
#   - which find
  - cmake --version
  - md c:\ros_build
  - cd c:\ros_build
  - call %APPVEYOR_BUILD_FOLDER%\configure.cmd %clang_configure_option% -DENABLE_ROSTESTS=1
  - ps: >-
      & ninja -k0 2>&1 | select-string -pattern "\[\d+\/\d+\] " -NotMatch | %{$_.Line}
  - ps: >-
      & ninja bootcdregtest 2>&1 | select-string -pattern "\[\d+\/\d+\] " -NotMatch | %{$_.Line}

after_build:
  - set SGVER=%APPVEYOR_BUILD_NUMBER%-%APPVEYOR_REPO_COMMIT:~0,7%-%BuildType%
  - appveyor PushArtifact bootcdregtest.iso -FileName bootcdregtest-%SGVER%.iso

test: off
deploy: off

for:
-
  matrix:
    only:
      - BuildType: vssolution
      - BuildType: vssolution-x64

  build_script:
    - set PATH=C:\RosCMakeNinja\bin;%PATH%
#     - call "C:\Program Files (x86)\Microsoft Visual Studio 10.0\VC\vcvarsall.bat" x86
    - if exist "C:\Program Files (x86)\Microsoft Visual Studio\2019\Preview\VC\Auxiliary\Build\vcvarsall.bat" (
          if "%BuildType%" == "vssolution-x64" (
              call "C:\Program Files (x86)\Microsoft Visual Studio\2019\Preview\VC\Auxiliary\Build\vcvarsall.bat" amd64
          ) else (
              call "C:\Program Files (x86)\Microsoft Visual Studio\2019\Preview\VC\Auxiliary\Build\vcvarsall.bat" x86
          )
      ) else (
          if "%BuildType%" == "vssolution-x64" (
              call "C:\Program Files (x86)\Microsoft Visual Studio\2019\Community\VC\Auxiliary\Build\vcvarsall.bat" amd64
          ) else (
              call "C:\Program Files (x86)\Microsoft Visual Studio\2019\Community\VC\Auxiliary\Build\vcvarsall.bat" x86
          )
      )
    - cmake --version
    - md C:\ros_build
    - cd C:\ros_build
    - call %APPVEYOR_BUILD_FOLDER%\configure.cmd VSSolution -DENABLE_ROSTESTS=1
    - msbuild /verbosity:quiet /target:bootcd REACTOS.sln
