name: Build
on: [push, pull_request]

jobs:
  build-gcc-i386:
    name: GCC (i386)
    runs-on: ubuntu-latest
    continue-on-error: ${{matrix.experimental}}
    strategy:
      fail-fast: false
      matrix:
        cmake_build_type: [Debug, Release]
        experimental: [false]
        include:
          - cmake_build_type: RelWithDebInfo
            experimental: false
          - cmake_build_type: MinSizeRel
            experimental: false
    steps:
      - name: Install RosBE
        run: |
          wget https://svn.reactos.org/storage/vperevertkin/rosbe-ci.tar.zst
          mkdir ${{github.workspace}}/rosbe
          tar -I zstd -xvf rosbe-ci.tar.zst --directory ${{github.workspace}}/rosbe
      - name: Install other packages
        run: sudo apt install ccache
      - uses: actions/checkout@v2
        with:
          path: src
      - name: Set up cache for ccache
        uses: actions/cache@v1
        with:
          path: ccache
          key: ccache-gcc-i386-${{matrix.cmake_build_type}}-${{github.sha}}
          restore-keys: |
            ccache-gcc-i386-${{matrix.cmake_build_type}}-
      - name: Set ccache settings
        run: |
          echo "::set-env name=CCACHE_BASEDIR::${{github.workspace}}"
          echo "::set-env name=CCACHE_DIR::${{github.workspace}}/ccache"
          echo "::set-env name=CCACHE_MAXSIZE::1G"
          echo "::set-env name=CCACHE_SLOPPINESS::time_macros"
      - name: Configure
        run: |
          mkdir build
          echo 'cd ${{github.workspace}}/build && ${{github.workspace}}/src/configure.sh -DENABLE_CCACHE=1 -DENABLE_ROSTESTS=1 -DENABLE_ROSAPPS=1 -DCMAKE_BUILD_TYPE=${{matrix.cmake_build_type}}' > commands
          ${{github.workspace}}/rosbe/RosBE.sh < commands
      - name: Build
        run: |
          echo 'cd ${{github.workspace}}/build && cmake --build . -- -k 0' > commands
          ${{github.workspace}}/rosbe/RosBE.sh < commands
      - name: Print ccache statistics
        run: ccache -s

  build-msvc-i386:
    name: MSVC (i386)
    runs-on: windows-latest
#     runs-on: ${{matrix.os}}
    continue-on-error: ${{matrix.experimental}}
    strategy:
      fail-fast: false
      matrix:
#         os: [windows-2016, windows-2019]
        cmake_build_type: [Debug, Release]
        experimental: [false]
#         include:
#           - cmake_build_type: RelWithDebInfo
#             experimental: true
#           - cmake_build_type: MinSizeRel
#             experimental: true
    steps:
    - name: Install packages
      run: choco install ninja -y
    - name: Add CL to PATH
      uses: ilammy/msvc-dev-cmd@v1
      with:
        arch: amd64_x86
    - uses: actions/checkout@v2
      with:
        path: src
    - name: Configure
      run: |
        mkdir build
        cd build
        cmake -G Ninja -DCMAKE_TOOLCHAIN_FILE:FILEPATH=toolchain-msvc.cmake -DARCH:STRING=i386 -DENABLE_ROSTESTS=1 -DENABLE_ROSAPPS=1 -DCMAKE_BUILD_TYPE=${{matrix.cmake_build_type}} ${{github.workspace}}\src
    - name: Build
      working-directory: ${{github.workspace}}\build
      run: cmake --build . -- -k 0 2>&1 | select-string -pattern "\[\d+\/\d+\] " -NotMatch | %{$_.Line}
