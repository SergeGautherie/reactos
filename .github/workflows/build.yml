name: Build
on: [push, pull_request]

jobs:
  build-msvc-i386-v141:
    name: MSVC (i386) (v141)
    runs-on: windows-2016
    steps:
    - name: Install packages
      run: choco install ninja -y
    - name: Install Flex and Bison
      run: |
        curl -O https://svn.reactos.org/storage/vperevertkin/flexbison.7z
        7z x flexbison.7z -O${{github.workspace}}\bin
        echo "::add-path::${{github.workspace}}\bin"
        echo "::set-env name=BISON_PKGDATADIR::${{github.workspace}}\bin\share\bison"
        echo "::set-env name=M4::${{github.workspace}}\bin\m4.exe"
    - name: Add CL to PATH
      uses: ilammy/msvc-dev-cmd@v1
      with:
        arch: amd64_x86
    - uses: actions/checkout@v2
      with:
        path: src
    - name: Configure
      run: |
        mkdir build
        cd build
        cmake -G Ninja -DCMAKE_TOOLCHAIN_FILE:FILEPATH=toolchain-msvc.cmake -DARCH:STRING=i386 ${{github.workspace}}\src
    - name: Build
      working-directory: ${{github.workspace}}\build
      run: cmake --build .

  build-msvc-i386-v142:
    name: MSVC (i386) (v142)
    runs-on: windows-2019
    steps:
    - name: Install packages
      run: choco install ninja -y
    - name: Install Flex and Bison
      run: |
        curl -O https://svn.reactos.org/storage/vperevertkin/flexbison.7z
        7z x flexbison.7z -O${{github.workspace}}\bin
        echo "::add-path::${{github.workspace}}\bin"
        echo "::set-env name=BISON_PKGDATADIR::${{github.workspace}}\bin\share\bison"
        echo "::set-env name=M4::${{github.workspace}}\bin\m4.exe"
    - name: Add CL to PATH
      uses: ilammy/msvc-dev-cmd@v1
      with:
        arch: amd64_x86
    - uses: actions/checkout@v2
      with:
        path: src
    - name: Configure
      run: |
        mkdir build
        cd build
        cmake -G Ninja -DCMAKE_TOOLCHAIN_FILE:FILEPATH=toolchain-msvc.cmake -DARCH:STRING=i386 ${{github.workspace}}\src
    - name: Build
      working-directory: ${{github.workspace}}\build
      run: cmake --build .

  build-msvc-amd64-v141:
    name: MSVC (amd64) (v141)
    runs-on: windows-2016
    steps:
    - name: Install packages
      run: choco install ninja -y
    - name: Install Flex and Bison
      run: |
        curl -O https://svn.reactos.org/storage/vperevertkin/flexbison.7z
        7z x flexbison.7z -O${{github.workspace}}\bin
        echo "::add-path::${{github.workspace}}\bin"
        echo "::set-env name=BISON_PKGDATADIR::${{github.workspace}}\bin\share\bison"
        echo "::set-env name=M4::${{github.workspace}}\bin\m4.exe"
    - name: Add CL to PATH
      uses: ilammy/msvc-dev-cmd@v1
      with:
        arch: amd64
    - uses: actions/checkout@v2
      with:
        path: src
    - name: Configure
      run: |
        mkdir build
        cd build
        cmake -G Ninja -DCMAKE_TOOLCHAIN_FILE:FILEPATH=toolchain-msvc.cmake -DARCH:STRING=amd64 ${{github.workspace}}\src
    - name: Build
      working-directory: ${{github.workspace}}\build
      run: |
        cmake --build .

  build-msvc-amd64-v142:
    name: MSVC (amd64) (v142)
    runs-on: windows-2019
    steps:
    - name: Install packages
      run: choco install ninja -y
    - name: Install Flex and Bison
      run: |
        curl -O https://svn.reactos.org/storage/vperevertkin/flexbison.7z
        7z x flexbison.7z -O${{github.workspace}}\bin
        echo "::add-path::${{github.workspace}}\bin"
        echo "::set-env name=BISON_PKGDATADIR::${{github.workspace}}\bin\share\bison"
        echo "::set-env name=M4::${{github.workspace}}\bin\m4.exe"
    - name: Add CL to PATH
      uses: ilammy/msvc-dev-cmd@v1
      with:
        arch: amd64
    - uses: actions/checkout@v2
      with:
        path: src
    - name: Configure
      run: |
        mkdir build
        cd build
        cmake -G Ninja -DCMAKE_TOOLCHAIN_FILE:FILEPATH=toolchain-msvc.cmake -DARCH:STRING=amd64 ${{github.workspace}}\src
    - name: Build
      working-directory: ${{github.workspace}}\build
      run: |
        cmake --build .
